{% extends "base.html" %}

{% block title %}My Decks - BrainDeck{% endblock %}
{% block breadcrumb %}My Decks{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto flex flex-col gap-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight mb-2">My Decks</h1>
            <p class="text-text-secondary">Manage your flashcard decks and study materials.</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="{{ url_for('ai.generate') }}"
                class="flex items-center justify-center gap-2 h-10 px-4 rounded-lg bg-surface-dark border border-primary/30 text-primary hover:bg-primary/10 transition-colors text-sm font-bold">
                <span class="material-symbols-outlined text-lg fill">auto_awesome</span>
                <span>AI Generate</span>
            </a>
            <a href="{{ url_for('flashcards.create_deck', parent_id=parent_deck.id if parent_deck else none) }}"
                class="flex items-center justify-center gap-2 h-10 px-4 rounded-lg btn-primary text-sm font-bold shadow-lg shadow-primary/20">
                <span class="material-symbols-outlined text-lg">add</span>
                <span>New Deck</span>
            </a>
        </div>
    </div>

    <!-- Breadcrumb Navigation -->
    {% if breadcrumb %}
    <div class="flex items-center gap-2 text-text-secondary text-sm">
        <a href="{{ url_for('flashcards.list_decks') }}" class="hover:text-white transition-colors">Home</a>
        {% for item in breadcrumb %}
        <span class="material-symbols-outlined text-[16px]">chevron_right</span>
        {% if loop.last %}
        <span class="text-white font-medium">{{ item.name }}</span>
        {% else %}
        <a href="{{ url_for('flashcards.list_decks', parent_id=item.id) }}"
            class="hover:text-white transition-colors">{{ item.name }}</a>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Filter Bar -->
    <div
        class="sticky top-0 z-10 bg-background-dark/95 backdrop-blur-sm py-4 border-b border-border-dark flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-3 flex-1 min-w-[200px]">
            <div class="relative">
                <span
                    class="absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary material-symbols-outlined text-[20px]">search</span>
                <input type="text" id="search-input" placeholder="Search decks..."
                    class="bg-surface-highlight border-none text-white text-sm rounded-lg pl-10 pr-4 py-2 w-64 focus:ring-2 focus:ring-primary placeholder:text-text-secondary/70">
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-sm text-text-secondary">{{ decks|length }} deck{{ 's' if decks|length != 1 else ''
                }}</span>
        </div>
    </div>

    <!-- Decks Grid -->
    {% if decks %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="decks-grid">
        {% for deck in decks %}
        <div class="deck-card group relative flex flex-col bg-surface-card rounded-xl border border-border-dark hover:border-primary/50 transition-all card-hover"
            data-name="{{ deck.name|lower }}">
            <div class="p-5 flex flex-col h-full">
                <div class="flex justify-between items-start mb-3">
                    <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                        {% if deck.is_folder %}
                        <span class="material-symbols-outlined fill">folder</span>
                        {% else %}
                        <span class="material-symbols-outlined fill">style</span>
                        {% endif %}
                    </div>
                    <div class="relative">
                        <button
                            class="text-text-secondary hover:text-white opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-surface-highlight"
                            onclick="toggleMenu(this)">
                            <span class="material-symbols-outlined">more_vert</span>
                        </button>
                        <div
                            class="dropdown-menu hidden absolute right-0 top-full mt-1 bg-surface-card border border-border-dark rounded-lg shadow-xl z-20 py-1 min-w-[140px]">
                            {% if deck.is_folder %}
                            <a href="{{ url_for('flashcards.list_decks', parent_id=deck.id) }}"
                                class="flex items-center gap-2 px-3 py-2 text-sm text-text-secondary hover:text-white hover:bg-surface-highlight">
                                <span class="material-symbols-outlined text-lg">folder_open</span>
                                Open Folder
                            </a>
                            {% else %}
                            <a href="{{ url_for('flashcards.list_flashcards', deck_id=deck.id) }}"
                                class="flex items-center gap-2 px-3 py-2 text-sm text-text-secondary hover:text-white hover:bg-surface-highlight">
                                <span class="material-symbols-outlined text-lg">visibility</span>
                                View Cards
                            </a>
                            {% endif %}
                            <form action="{{ url_for('flashcards.delete_deck', deck_id=deck.id) }}" method="POST"
                                onsubmit="return confirm('Delete this {{ 'folder' if deck.is_folder else 'deck' }} and all its content?');">
                                <button type="submit"
                                    class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-400 hover:bg-surface-highlight">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <h3 class="text-white font-bold text-lg mb-1 leading-snug group-hover:text-primary transition-colors">
                    {% if deck.is_folder %}
                    <a href="{{ url_for('flashcards.list_decks', parent_id=deck.id) }}">{{ deck.name }}</a>
                    {% else %}
                    <a href="{{ url_for('flashcards.list_flashcards', deck_id=deck.id) }}">{{ deck.name }}</a>
                    {% endif %}
                </h3>

                {% if deck.tags %}
                <div class="flex flex-wrap gap-2 mb-3">
                    {% for tag in deck.tags.split(',')[:3] %}
                    <span
                        class="text-xs px-2 py-0.5 rounded-full bg-background-dark text-text-secondary border border-border-dark">{{
                        tag.strip() }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if deck.description %}
                <p class="text-sm text-text-secondary mb-4 line-clamp-2">{{ deck.description }}</p>
                {% endif %}

                <div class="mt-auto">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <p class="text-text-secondary text-xs font-medium uppercase tracking-wider mb-1">
                                {% if deck.is_folder %}Sub-items{% else %}Cards{% endif %}
                            </p>
                            <span class="text-2xl font-bold text-white">
                                {% if deck.is_folder %}
                                {{ deck.children.count() }}
                                {% else %}
                                {{ deck.total_card_count }}
                                {% endif %}
                            </span>
                        </div>
                        {% if deck.category %}
                        <span class="text-xs text-text-secondary">{{ deck.category }}</span>
                        {% endif %}
                    </div>

                    <div class="flex items-center justify-between pt-3 border-t border-border-dark">
                        {% if deck.is_folder %}
                        <a href="{{ url_for('flashcards.list_decks', parent_id=deck.id) }}"
                            class="flex items-center gap-1 text-sm font-medium text-primary hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-lg">folder_open</span>
                            Open
                        </a>
                        {% else %}
                        <a href="{{ url_for('study.study_session') }}?deck_id={{ deck.id }}"
                            class="flex items-center gap-1 text-sm font-medium text-primary hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-lg">play_arrow</span>
                            Study
                        </a>
                        {% endif %}
                        <span class="text-xs text-text-secondary">
                            {{ (deck.updated_at|to_ist).strftime('%b %d') if deck.updated_at else 'New' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Create New Deck Card -->
        <a href="{{ url_for('flashcards.create_deck') }}"
            class="group flex flex-col items-center justify-center bg-surface-dark/30 rounded-xl border-2 border-dashed border-border-dark hover:border-primary/50 hover:bg-surface-dark/50 transition-all min-h-[240px]">
            <div
                class="w-16 h-16 rounded-full bg-background-dark flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-3xl text-primary">add</span>
            </div>
            <h3 class="text-white font-bold text-lg mb-1">Create New Deck</h3>
            <p class="text-text-secondary text-sm text-center px-8">Add a new topic or import from CSV</p>
        </a>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="bg-surface-card rounded-xl border border-border-dark p-16 text-center">
        <div class="w-20 h-20 rounded-full bg-surface-highlight flex items-center justify-center mx-auto mb-6">
            <span class="material-symbols-outlined text-4xl text-text-secondary">folder_open</span>
        </div>
        <h3 class="text-white font-bold text-xl mb-3">No decks yet</h3>
        <p class="text-text-secondary mb-8 max-w-md mx-auto">
            Create your first deck to start organizing your flashcards, or let AI generate cards from your notes.
        </p>
        <div class="flex justify-center gap-4">
            <a href="{{ url_for('flashcards.create_deck') }}" class="btn-secondary px-5 py-2.5 rounded-lg font-medium">
                Create Manually
            </a>
            <a href="{{ url_for('ai.generate') }}"
                class="btn-primary px-5 py-2.5 rounded-lg font-medium flex items-center gap-2">
                <span class="material-symbols-outlined text-lg">auto_awesome</span>
                Generate with AI
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Search functionality
    document.getElementById('search-input')?.addEventListener('input', function (e) {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.deck-card').forEach(card => {
            const name = card.dataset.name;
            card.style.display = name.includes(query) ? 'flex' : 'none';
        });
    });

    // Dropdown menu toggle
    function toggleMenu(btn) {
        const menu = btn.nextElementSibling;
        const isOpen = !menu.classList.contains('hidden');

        // Close all other menus
        document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));

        if (!isOpen) {
            menu.classList.remove('hidden');
        }
    }

    // Close menus when clicking outside
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.relative')) {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));
        }
    });
</script>
{% endblock %}